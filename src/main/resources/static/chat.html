<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>PRISM AI | Enterprise Intelligence</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><defs><linearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'><stop offset='0%25' stop-color='%233B82F6'/><stop offset='50%25' stop-color='%237C3AED'/><stop offset='100%25' stop-color='%23DB2777'/></linearGradient></defs><path fill='url(%23g)' d='M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z'/></svg>" type="image/svg+xml">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600&family=Plus+Jakarta+Sans:wght@500;600;700;800&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/tokyo-night-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --bg-deep: #0B0E14;
            --bg-sidebar: #11151C;
            --accent: #2563EB;
            --accent-glow: rgba(37, 99, 235, 0.4);
            --text-high: #F3F4F6;
            --text-muted: #9CA3AF;
            --border: rgba(255, 255, 255, 0.08);
            --code-bg: #161B22;
            --modal-bg: rgba(17, 21, 28, 0.85);
        }

        html, body {
            margin: 0; padding: 0; height: 100%; width: 100%;
            background: var(--bg-deep); color: var(--text-high);
            font-family: 'Outfit', sans-serif;
            -webkit-font-smoothing: antialiased;
            overflow: hidden;
            box-sizing: border-box;
        }

        *, *::before, *::after { box-sizing: inherit; outline: none; }

        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.1); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.2); }

        .app { display: flex; height: 100vh; width: 100vw; }

        /* ================= SIDEBAR ================= */
        .sidebar { width: 280px; background: var(--bg-sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; flex-shrink: 0; transition: all 0.3s ease; }
        .sidebar-header { padding: 32px 24px 15px 24px; }

        .brand {
            font-family: 'Plus Jakarta Sans', sans-serif; font-size: 18px; font-weight: 800; color: #fff;
            display: flex; align-items: center; gap: 12px; letter-spacing: -0.5px;
        }

        .prism-icon {
            width: 36px; height: 36px;
            background: linear-gradient(135deg, #3B82F6 0%, #7C3AED 50%, #DB2777 100%);
            border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white;
            box-shadow:
                0 4px 20px rgba(124, 58, 237, 0.4),
                inset 0 2px 5px rgba(255, 255, 255, 0.4),
                inset 0 -3px 5px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative; overflow: hidden;
        }
        .prism-icon::after {
            content: ''; position: absolute; top: 0; left: -100%; width: 50%; height: 100%;
            background: linear-gradient(to right, transparent, rgba(255,255,255,0.5), transparent);
            transform: skewX(-20deg); animation: shine 3.5s infinite;
        }
        @keyframes shine { 0% { left: -100%; } 20%, 100% { left: 200%; } }

        .select-container { padding: 10px 24px; }
        .model-select {
            width: 100%; background: rgba(255,255,255,0.03); border: 1px solid var(--border); color: var(--text-high); padding: 12px 14px;
            border-radius: 12px; cursor: pointer; font-size: 13.5px; appearance: none; transition: 0.2s; font-family: inherit; font-weight: 500;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%239CA3AF' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat; background-position: right 14px center; background-size: 12px;
        }
        .model-select:hover, .model-select:focus { border-color: var(--accent); background: rgba(255,255,255,0.05); }
        .model-select option { background-color: var(--bg-sidebar); color: var(--text-high); }

        .new-chat-btn {
            margin: 15px 24px 20px 24px; display: flex; align-items: center; justify-content: center; gap: 8px;
            padding: 10px 16px; background: rgba(255, 255, 255, 0.03); color: var(--text-high); border-radius: 8px;
            font-size: 13.5px; font-weight: 500; cursor: pointer; border: 1px solid rgba(255,255,255,0.08); transition: all 0.2s ease;
        }
        .new-chat-btn:hover { background: rgba(37, 99, 235, 0.1); border-color: var(--accent); color: #60A5FA; }

        .conv-heading { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1.5px; padding: 10px 24px; font-weight: 700; opacity: 0.7; }
        .session-list { flex: 1; overflow-y: auto; padding: 0 16px; display: flex; flex-direction: column; gap: 4px; }
        .session-item {
            padding: 12px 14px; border-radius: 10px; font-size: 13.5px; color: var(--text-muted); font-weight: 400;
            cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; justify-content: space-between; height: 44px;
        }
        .session-item:hover { background: rgba(255,255,255,0.04); color: #fff; }
        .session-item.active { background: rgba(37, 99, 235, 0.15); color: var(--accent); font-weight: 500; border-left: 3px solid var(--accent); }

        .chat-title { display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 170px; }
        .delete-trigger { opacity: 0; color: var(--text-muted); cursor: pointer; transition: 0.2s; }
        .session-item:hover .delete-trigger { opacity: 0.6; }
        .delete-trigger:hover { color: #ef4444; opacity: 1 !important; transform: scale(1.1); }

        .sidebar-footer { padding: 20px 24px; border-top: 1px solid var(--border); }
        .logout-link { display: flex; align-items: center; gap: 10px; color: var(--text-muted); cursor: pointer; font-size: 14px; font-weight: 500; transition: 0.2s; }
        .logout-link:hover { color: #ef4444; }

        /* ================= CHAT PANEL ================= */
        .chat-panel { flex: 1; display: flex; flex-direction: column; position: relative; align-items: center; background: var(--bg-deep); min-width: 0; }

        .chat-header {
            width: 100%; height: 65px; display: flex; align-items: center; justify-content: center;
            background: rgba(11, 14, 20, 0.7); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            z-index: 10; position: sticky; top: 0; border-bottom: 1px solid transparent; transition: 0.3s;
        }
        .chat-header-title { font-size: 15px; font-weight: 600; color: var(--text-high); }

        .messages {
            width: 100%; max-width: 850px; flex: 1; overflow-y: auto; overflow-x: hidden;
            padding: 40px 24px 200px 24px; display: flex; flex-direction: column; gap: 32px; scroll-behavior: smooth;
        }

        .msg-row { display: flex; width: 100%; opacity: 0; animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        /* User Glass Bubble */
        .user-row { justify-content: flex-end; }
        .user-row .llm-msg {
            background: linear-gradient(145deg, rgba(37, 99, 235, 0.25), rgba(37, 99, 235, 0.08));
            backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(59, 130, 246, 0.35);
            color: #fff; padding: 14px 20px;
            border-radius: 20px 20px 4px 20px; max-width: 85%; font-size: 15.5px; line-height: 1.6;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2), inset 0 1px 1px rgba(255, 255, 255, 0.15);
            overflow-wrap: break-word; word-wrap: break-word; white-space: pre-wrap; word-break: break-word;
        }

        /* AI Bubble & Flex Fix */
        .ai-row { justify-content: flex-start; }
        .ai-row .llm-msg {
            max-width: 90%; display: flex; gap: 16px;
            min-width: 0; /* CRITICAL FIX: prevents the bubble from exploding screen width */
        }

        .ai-avatar {
            width: 32px; height: 32px; border-radius: 10px; flex-shrink: 0; display: flex; align-items: center; justify-content: center;
            background: linear-gradient(135deg, #3B82F6 0%, #7C3AED 50%, #DB2777 100%); color: white; margin-top: 4px;
            box-shadow: 0 4px 15px rgba(124, 58, 237, 0.3), inset 0 2px 4px rgba(255, 255, 255, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .ai-content {
            flex: 1; color: var(--text-high); font-size: 16px; line-height: 1.8; letter-spacing: 0.01em;
            min-width: 0; /* CRITICAL FIX: Stops <pre> code blocks from pushing past 100% width */
        }

        /* Advanced Markdown Styling */
        .ai-content p { margin: 0 0 16px 0; }
        .ai-content p:last-child { margin-bottom: 0; }
        .ai-content strong { color: #fff; font-weight: 600; }
        .ai-content a { color: var(--accent); text-decoration: none; border-bottom: 1px solid transparent; transition: 0.2s; }
        .ai-content a:hover { border-bottom-color: var(--accent); }
        .ai-content hr { border: none; border-top: 1px solid var(--border); margin: 24px 0; }
        .ai-content > *:first-child { margin-top: 0; }

        /* CODE BLOCK BUG FIXES */
        pre {
            background: var(--code-bg) !important;
            border-radius: 12px;
            padding: 0;
            border: 1px solid var(--border);
            position: relative;
            margin: 20px 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            width: 100%;
        }

        pre code {
            display: block;
            overflow-x: auto;
            padding: 45px 20px 20px 20px;
            font-family: 'Fira Code', monospace;
            font-size: 14px;
            color: #E2E8F0;
            white-space: pre;
            word-break: normal;
            overflow-wrap: normal;
        }

        pre code::-webkit-scrollbar { height: 8px; }
        pre code::-webkit-scrollbar-track { background: transparent; }
        pre code::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.15); border-radius: 4px; }
        pre code::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.3); }

        .ai-content p > code { background: rgba(255,255,255,0.08); padding: 2px 6px; border-radius: 6px; font-size: 13.5px; color: #60A5FA; }

        .copy-btn {
            position: absolute; top: 10px; right: 10px; padding: 6px 12px;
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            color: var(--text-muted); border-radius: 8px; font-size: 12px;
            cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 6px;
            z-index: 10; backdrop-filter: blur(5px);
        }
        .copy-btn:hover { background: rgba(255,255,255,0.15); color: #fff; }

        /* ================= COMPOSER ================= */
        .composer-canvas {
            position: absolute; bottom: 0; width: 100%; display: flex; justify-content: center;
            padding: 0 24px 32px 24px; pointer-events: none;
            background: linear-gradient(to top, var(--bg-deep) 40%, rgba(11, 14, 20, 0.8) 75%, transparent);
            z-index: 20;
        }
        .composer-box {
            width: 100%; max-width: 800px; background: rgba(22, 27, 34, 0.6); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border); border-radius: 20px; display: flex; align-items: flex-end; padding: 12px 18px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5); pointer-events: auto; transition: 0.3s;
        }
        .composer-box:focus-within { border-color: rgba(37, 99, 235, 0.5); box-shadow: 0 10px 40px rgba(0,0,0,0.6), 0 0 0 2px rgba(37, 99, 235, 0.1); }

        .input-area {
            flex: 1; background: transparent; border: none !important; color: #fff; font-size: 15.5px;
            outline: none !important; box-shadow: none !important; resize: none; max-height: 200px; padding: 8px 0; font-family: inherit; line-height: 1.5;
        }
        .input-area::placeholder { color: #6B7280; }

        .action-container { display: flex; align-items: center; justify-content: center; margin-left: 12px; padding-bottom: 4px; }

        .send-btn {
            background: transparent; color: var(--text-muted); border: none; cursor: pointer;
            padding: 8px; display: flex; align-items: center; transition: 0.2s;
            pointer-events: none; opacity: 0.5;
        }
        .send-btn.active { color: var(--accent); pointer-events: auto; opacity: 1; }
        .send-btn svg, .cancel-btn svg { pointer-events: none; }
        .cancel-btn {
            background: rgba(255, 255, 255, 0.08); backdrop-filter: blur(8px); color: var(--accent);
            border: 1px solid var(--border); width: 30px; height: 30px; border-radius: 50%;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            margin-left: 8px; transition: 0.2s;
        }
        .cancel-btn:hover { background: rgba(239, 68, 68, 0.1); color: #EF4444; border-color: rgba(239, 68, 68, 0.3); }
        .hidden { display: none !important; }

        /* ================= ANIMATIONS ================= */
        .typing-indicator { display: flex; align-items: center; gap: 4px; padding: 8px 0; height: 24px; }
        .typing-indicator span {
            display: inline-block; width: 6px; height: 6px; background: var(--accent);
            border-radius: 50%; animation: bounce 1.4s infinite ease-in-out both;
        }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); opacity: 0.4; } 40% { transform: scale(1); opacity: 1; } }

        /* ================= MODAL ================= */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.6); display: none; align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); }
        .modal-card { background: var(--modal-bg); padding: 32px; border-radius: 20px; width: 360px; border: 1px solid var(--border); text-align: center; box-shadow: 0 30px 60px rgba(0,0,0,0.8); animation: modalScale 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes modalScale { from { opacity: 0; transform: scale(0.95) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        .modal-icon { color: #ef4444; background: rgba(239, 68, 68, 0.1); width: 64px; height: 64px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; }
        .modal-card h3 { margin: 0 0 10px 0; font-size: 20px; color: #fff; }
        .modal-card p { margin: 0 0 24px 0; color: var(--text-muted); font-size: 14.5px; line-height: 1.5; }
        .modal-btn { flex: 1; padding: 12px; border-radius: 10px; font-weight: 600; cursor: pointer; border: none; font-size: 14px; transition: 0.2s; }
        .btn-confirm { background: #ef4444; color: #fff; }
        .btn-confirm:hover { background: #dc2626; }
        .btn-cancel { background: transparent; color: #fff; border: 1px solid var(--border); }
        .btn-cancel:hover { background: rgba(255,255,255,0.05); }
    </style>
</head>
<body>

<div class="modal-overlay" id="deleteModal">
    <div class="modal-card">
        <div class="modal-icon"><i data-lucide="alert-triangle" size="32"></i></div>
        <h3>Delete Thread?</h3>
        <p>This action is final. You will lose all messages in this conversation permanently.</p>
        <div style="display:flex; gap:12px;">
            <button class="modal-btn btn-cancel" onclick="closeModal()">Keep</button>
            <button class="modal-btn btn-confirm" id="confirmDelete">Delete</button>
        </div>
    </div>
</div>

<div class="app">
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="brand">
                <div class="prism-icon"><i data-lucide="hexagon" fill="white" size="18"></i></div>
                PRISM AI
            </div>
        </div>

        <div class="select-container">
            <select id="providerSelect" class="model-select">
                <option value="groq">Groq Llama 3 Fast</option>
                <option value="gemini">Google Gemini Pro</option>
            </select>
        </div>
        <button class="new-chat-btn" onclick="createNewSession()"><i data-lucide="plus" size="16"></i> New Thread</button>

        <div class="conv-heading">Recent Activity</div>
        <div id="sessionList" class="session-list"></div>

        <div class="sidebar-footer">
            <a class="logout-link" onclick="logout()"><i data-lucide="log-out" size="18"></i> Sign Out</a>
        </div>
    </aside>

    <main class="chat-panel">
        <header class="chat-header">
            <div class="chat-header-title" id="activeChatTitle">New Thread</div>
        </header>

        <div id="messages" class="messages"></div>

        <div class="composer-canvas">
            <div class="composer-box">
                <textarea id="prompt" class="input-area" placeholder="Ask anything..." rows="1" maxlength="2000"></textarea>
                <div class="action-container">
                    <button id="sendBtn" class="send-btn" onclick="startStream()" disabled>
                        <i data-lucide="navigation" size="22" fill="currentColor"></i>
                    </button>
                    <button id="cancelBtn" class="cancel-btn hidden" onclick="cancelStream()">
                        <i data-lucide="square" size="14" fill="currentColor"></i>
                    </button>
                </div>
            </div>
        </div>
    </main>
</div>

<script>
    lucide.createIcons();
    let token = localStorage.getItem("accessToken");
    let refreshToken = localStorage.getItem("refreshToken");
    if (!token) window.location.href = "login.html";

    let currentSessionId = null;
    let abortController = null;
    let streamReader = null;
    let isStreaming = false;
    let pendingDeleteId = null;
    let streamUpdateTimer = null;

    marked.setOptions({ breaks: true, gfm: true });

    function openModal(sessionId) { pendingDeleteId = sessionId; document.getElementById('deleteModal').style.display = 'flex'; }
    function closeModal() { document.getElementById('deleteModal').style.display = 'none'; }
    document.getElementById('confirmDelete').onclick = () => { if(pendingDeleteId) executeDelete(pendingDeleteId); closeModal(); };

    function logout() { localStorage.clear(); window.location.href = "login.html"; }

    async function handleResponse(response, retryFunc) {
        if (response.status === 401) {
            const res = await fetch("http://localhost:8081/auth/refresh", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ refreshToken }) });
            if (res.ok) {
                const data = await res.json(); token = data.accessToken; refreshToken = data.refreshToken;
                localStorage.setItem("accessToken", token); localStorage.setItem("refreshToken", refreshToken);
                return await retryFunc();
            }
            logout(); return null;
        }
        return response;
    }

    function renderMarkdown(el, text) {
        el.innerHTML = marked.parse(text);
        el.querySelectorAll('pre code').forEach(b => hljs.highlightElement(b));
        el.querySelectorAll('pre').forEach(pre => {
            if (pre.querySelector('.copy-btn')) return;
            const btn = document.createElement('button');
            btn.className = 'copy-btn';
            btn.innerHTML = '<i data-lucide="copy" size="14"></i> Copy';
            btn.onclick = () => {
                navigator.clipboard.writeText(pre.querySelector('code').innerText);
                btn.innerHTML = '<i data-lucide="check" size="14"></i> Copied';
                lucide.createIcons();
                setTimeout(() => { btn.innerHTML = '<i data-lucide="copy" size="14"></i> Copy'; lucide.createIcons(); }, 2000);
            };
            pre.appendChild(btn);
        });
        lucide.createIcons();
    }

    function appendMessage(role, content, isHistory = false) {
        const container = document.getElementById("messages");
        const row = document.createElement("div");
        row.className = `msg-row ${role === "user" ? "user-row" : "ai-row"}`;

        if (role === "assistant") {
            row.innerHTML = `
                <div class="llm-msg">
                    <div class="ai-avatar"><i data-lucide="hexagon" fill="white" size="16"></i></div>
                    <div class="ai-content content"></div>
                </div>`;
            container.appendChild(row);
            const contentEl = row.querySelector(".content");
            if (content === '...') {
                contentEl.innerHTML = '<div class="typing-indicator"><span></span><span></span><span></span></div>';
            } else {
                renderMarkdown(contentEl, content);
            }
            lucide.createIcons();
            return contentEl;
        } else {
            row.innerHTML = `<div class="llm-msg content"></div>`;
            container.appendChild(row);
            const contentEl = row.querySelector(".content");
            contentEl.innerText = content;
            return contentEl;
        }
    }

    async function executeDelete(sessionId) {
        // Wrapped in handleResponse to prevent 401 failures
        const rawRes = await fetch(`/v1/api/sessions/${sessionId}/deleteSession`, { method: "DELETE", headers: { "Authorization": `Bearer ${token}` } });
        const res = await handleResponse(rawRes, () => executeDelete(sessionId));
        if (!res) return;

        if (currentSessionId === sessionId) {
            currentSessionId = null;
            document.getElementById("messages").innerHTML = "";
            document.getElementById("activeChatTitle").innerText = "New Thread";
        }
        loadSessions();
    }

    async function loadSessions() {
        const rawRes = await fetch(`/v1/api/loadSessions`, { headers: { "Authorization": `Bearer ${token}` } });
        const res = await handleResponse(rawRes, loadSessions);
        if (!res) return;
        const sessions = await res.json();
        const list = document.getElementById("sessionList");
        list.innerHTML = "";
        sessions.forEach(s => {
            const div = document.createElement("div");
            div.className = `session-item ${currentSessionId === s.sessionId ? 'active' : ''}`;
            div.onclick = () => {
                if (isStreaming) cancelStream(); // Added safety
                currentSessionId = s.sessionId;
                document.getElementById('activeChatTitle').innerText = s.title || "Untitled Chat";
                document.querySelectorAll('.session-item').forEach(el => el.classList.remove('active'));
                div.classList.add('active');
                loadMessages(s.sessionId);
            };
            div.innerHTML = `<span class="chat-title">${s.title || "Untitled Chat"}</span><i data-lucide="trash-2" size="14" class="delete-trigger" onclick="event.stopPropagation(); openModal(${s.sessionId})"></i>`;
            list.appendChild(div);
        });
        lucide.createIcons();
    }

    async function loadMessages(sessionId) {
        const rawRes = await fetch(`/v1/api/sessions/${sessionId}/messages`, { headers: { "Authorization": `Bearer ${token}` } });
        const res = await handleResponse(rawRes, () => loadMessages(sessionId));
        if (!res) return;
        const data = await res.json();
        const container = document.getElementById("messages");
        container.innerHTML = "";
        (Array.isArray(data) ? data : (data.body || [])).forEach(m => appendMessage(m.role, m.content, true));
        smoothScroll(true); // Force scroll on load
    }

    async function startStream() {
        if (isStreaming) return;
        const promptEl = document.getElementById("prompt");
        const msg = promptEl.value.trim(); if (!msg) return;
        const pName = document.getElementById("providerSelect").options[document.getElementById("providerSelect").selectedIndex].text;

        isStreaming = true;
        appendMessage('user', msg);
        const bubble = appendMessage('assistant', '...');

        promptEl.value = ""; promptEl.style.height = "auto";
        document.getElementById('sendBtn').classList.remove('active');
        document.getElementById('sendBtn').disabled = true;
        smoothScroll(true); // Force scroll to bottom when starting new message

        document.getElementById('sendBtn').classList.add('hidden');
        document.getElementById('cancelBtn').classList.remove('hidden');
        executeStreamInternal(msg, document.getElementById("providerSelect").value, bubble, pName);
    }

    async function executeStreamInternal(msg, provider, bubble, pName, isRetry = false) {
        abortController = new AbortController();
        let streamBuffer = "";
        let partialLine = "";

        try {
            // Updated to POST method with JSON body
            const url = `/v1/api/stream`;
            const payload = {
                prompt: msg,
                sessionId: currentSessionId || null,
                provider: provider
            };

            let rawRes = await fetch(url, {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${token}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(payload),
                signal: abortController.signal
            });

            // Handle Silent Token Refresh During Streaming
            if (rawRes.status === 401 && !isRetry) {
                const refreshRes = await fetch("http://localhost:8081/auth/refresh", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ refreshToken })
                });

                if (refreshRes.ok) {
                    const data = await refreshRes.json();
                    token = data.accessToken;
                    refreshToken = data.refreshToken;
                    localStorage.setItem("accessToken", token);
                    localStorage.setItem("refreshToken", refreshToken);

                    // Retry the stream seamlessly
                    return executeStreamInternal(msg, provider, bubble, pName, true);
                } else {
                    logout();
                    return;
                }
            }

            if (!rawRes.ok) throw new Error(`Stream failed: ${rawRes.status}`);

            streamReader = rawRes.body.getReader();
            const decoder = new TextDecoder();
            bubble.innerHTML = "";

            while (isStreaming) {
                const { done, value } = await streamReader.read();
                if (done) break;

                const chunk = partialLine + decoder.decode(value, { stream: true });
                const lines = chunk.split("\n");
                partialLine = lines.pop();

                let newContentAdded = false;

                for (let line of lines) {
                    line = line.trim();
                    if (!line) continue;

                    const parts = line.split("data:").filter(p => p.trim() !== "");

                    for (let part of parts) {
                        part = part.trim();
                        if (part === "[DONE]") continue;

                        try {
                            const json = JSON.parse(part);
                            if (json.done) continue;

                            if (json.content) {
                                streamBuffer += json.content;
                                newContentAdded = true;
                            }
                        } catch (e) {
                            // Silently ignore
                        }
                    }
                }

                if (newContentAdded && isStreaming) {
                    if (streamUpdateTimer) cancelAnimationFrame(streamUpdateTimer);
                    streamUpdateTimer = requestAnimationFrame(() => {
                        renderMarkdown(bubble, streamBuffer);
                        smoothScroll(false); // False allows user to scroll up without snapping
                    });
                }
            }

            if (partialLine && isStreaming) {
                const parts = partialLine.split("data:").filter(p => p.trim() !== "");
                for (let part of parts) {
                    try {
                        const json = JSON.parse(part.trim());
                        if (json.content) streamBuffer += json.content;
                    } catch(e) {}
                }
                if (streamBuffer) {
                    renderMarkdown(bubble, streamBuffer);
                    smoothScroll(false);
                }
            }

        } catch (err) {
            if (streamUpdateTimer) cancelAnimationFrame(streamUpdateTimer);
            if (err.name === "AbortError" || !isStreaming) {
                renderMarkdown(bubble, streamBuffer + " ðŸ›‘ You stopped this response");
            }
            smoothScroll(true);
        } finally {
            isStreaming = false;
            streamReader = null;
            document.getElementById("sendBtn").classList.remove("hidden");
            document.getElementById("cancelBtn").classList.add("hidden");
            lucide.createIcons();
            if (document.querySelectorAll(".msg-row").length <= 2) setTimeout(loadSessions, 1500);
        }
    }

    async function createNewSession() {
        if (isStreaming) cancelStream(); // Fixes the button getting stuck

        // Wrapped in handleResponse to prevent 401 failures
        const rawRes = await fetch(`/v1/api/createSession`, { method: "POST", headers: { "Authorization": `Bearer ${token}` } });
        const res = await handleResponse(rawRes, createNewSession);
        if (!res) return;

        currentSessionId = (await res.json()).sessionId;
        document.getElementById("messages").innerHTML = "";
        document.getElementById("activeChatTitle").innerText = "New Thread";
        loadSessions();
    }

    // Smart Scrolling: Only auto-scrolls if you are already at the bottom
    function smoothScroll(force = false) {
        const msgDiv = document.getElementById("messages");
        const threshold = 150; // pixels
        const isNearBottom = (msgDiv.scrollHeight - msgDiv.scrollTop - msgDiv.clientHeight) < threshold;

        if (force || isNearBottom) {
            msgDiv.scrollTop = msgDiv.scrollHeight;
        }
    }

    function cancelStream() {
        isStreaming = false;
        if (abortController) {
            abortController.abort();
        }
        if (streamReader) {
            streamReader.cancel().catch(() => {});
        }
    }

    document.getElementById('prompt').addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 200) + 'px';
        const sendBtn = document.getElementById('sendBtn');
        if (this.value.trim().length > 0) {
            sendBtn.classList.add('active');
            sendBtn.disabled = false;
        } else {
            sendBtn.classList.remove('active');
            sendBtn.disabled = true;
        }
    });

    document.getElementById('prompt').onkeydown = (e) => {
        if(e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            if(document.getElementById('prompt').value.trim().length > 0) startStream();
        }
    };

    window.onload = loadSessions;
</script>
</body>
</html>